<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/gujaratilexicon/fonts@master/fonts/gopika/Gopika.ttf" as="font" type="font/ttf" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Gujarati:wght@400;700&display=swap" rel="stylesheet">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Draw with music!</title>
  <link rel="stylesheet" href="https://use.typekit.net/xvl8ddx.css">
  <script src="https://cdn.jsdelivr.net/npm/tone@14.8.49/build/Tone.min.js"></script>
  <style>
/* Unify stencil button size and spacing for shapes grid */
.shapes-item {
  width: clamp(60px, 10vw, 80px) !important;
  height: clamp(60px, 10vw, 80px) !important;
  border-radius: 50%;
  background: white;
  border: 2px solid #ccc;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  margin: 0;
  padding: 0;
  font-size: 1.2rem;
  user-select: none;
}

.shapes-item:hover {
  border-color: #ffb700;
}

#shapesGrid {
  gap: 15px !important;
  grid-template-columns: repeat(3, 1fr);
  justify-items: center;
  align-items: center;
}

@font-face {
  font-family: 'Gopika';
  src: url('https://cdn.jsdelivr.net/gh/gujaratilexicon/fonts@master/fonts/gopika/Gopika.ttf') format('truetype');
  font-weight: normal;
  font-style: normal;
}

/* Gujarati button styles */
.gujarati-button {
  background-color: #000;
  color: #fff;
  font-size: clamp(1.2rem, 2vw, 1.8rem);
  font-family: 'Gopika', 'Noto Sans Gujarati', sans-serif !important;
  border-radius: 50%;
  border: 2px solid #666;
  width: clamp(60px, 10vw, 80px);
  height: clamp(60px, 10vw, 80px);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.gujarati-button:hover {
  background-color: #222;
  border-color: #ffb700;
}

#gujaratiGridModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000 !important;
}

#gujaratiGrid {
  background: white;
  border-radius: 20px;
  padding: 20px;
  max-width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  display: grid;
  grid-template-columns: repeat(12, 1fr);
  gap: 10px;
  position: relative;
}

.gujarati-item {
  width: clamp(60px, 8vw, 80px);
  height: clamp(60px, 8vw, 80px);
  border: 2px solid #ccc;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(1.2rem, 2vw, 2rem);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  background: white;
  color: #222;
  font-family: 'Gopika', 'Noto Sans Gujarati', sans-serif !important;
}

.gujarati-item:hover {
  transform: scale(1.1);
  border-color: #ffb700;
  background: #fff7e0;
}

#closeGujaratiGrid {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  border: none;
  background: #ffb700;
  color: white;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

/* Overlay cross button for stencil mode */
#stencilCloseBtn {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #222;
  border: 2px solid #fff;
  color: white;
  font-size: 2rem;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  display: none;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  z-index: 100;
}

#stencilCloseBtn:before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 24px;
  height: 2px;
  background: white;
  border-radius: 1px;
  transform: translate(-50%, -50%) rotate(45deg);
}

#stencilCloseBtn:after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 24px;
  height: 2px;
  background: white;
  border-radius: 1px;
  transform: translate(-50%, -50%) rotate(-45deg);
}

#stencilCloseBtn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

@font-face {
  font-family: "CLT Apfel Grotezk";
  src: url("CLT Apfel Grotezk/web/ApfelGrotezk-Regular.woff2") format("woff2");
}

@font-face {
  font-family: "Comic Sans MS";
  src: url("data:font/woff;base64,d09GRgABAAAAAAw0ABAAAAAAQ8gAA...TRUNCATED_BASE64...AA==") format("woff"), local("Comic Sans MS"), local("Comic Sans"), url("https://fonts.cdnfonts.com/s/14617/Comic_Sans_MS.woff") format("woff");
  font-style: normal;
  font-weight: normal;
}

html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  height: 100vh;
  width: 100vw;
  font-family: "CLT Apfel Grotezk", sans-serif !important;
  background: url('white-wall.jpg') no-repeat center center fixed;
  background-size: cover;
  touch-action: none;
  -webkit-tap-highlight-color: transparent;
  overscroll-behavior: none;
}

#title {
  position: fixed;
  top: 0;
  width: 100%;
  text-align: center;
  background: white;
  font-size: clamp(1rem, 2vw, 2.5rem);
  font-weight: bold;
  padding: clamp(0.5rem, 0.9rem, 1.2rem);
  z-index: 10;
  animation: floatTitle 4s ease-in-out infinite;
  transition: transform 0.3s ease;
}

@keyframes floatTitle {
  0%, 100% {
    transform: translateY(7px);
  }
  50% {
    transform: translateY(-7px);
  }
}

#prompt {
  position: fixed;
  top: 90%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(255,255,255,0.95);
  padding: clamp(0.8rem, 1rem, 1.5rem) clamp(1.2rem, 2rem, 2.5rem);
  border-radius: 20px;
  font-size: clamp(0.8rem, 1vw, 1.2rem);
  font-weight: bold;
  z-index: 20;
  animation: fadeOut 2s 2s forwards;
  text-align: center;
  max-width: 90vw;
  box-sizing: border-box;
}

@keyframes fadeOut {
  to {
    opacity: 0;
    visibility: hidden;
  }
}

canvas {
  display: block;
  position: absolute;
  top: 0;
  left: 0;
  z-index: 1;
  width: 100vw;
  height: 100vh;
  max-width: 100vw;
  max-height: 100vh;
  touch-action: none;
}

#aOverlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  z-index: 2;
  pointer-events: none;
  display: none;
}

/* FIXED BUTTON CONTAINER WITH EQUAL SIZING */
#buttonContainer {
  position: fixed;
  top: clamp(80px, 15vh, 120px);
  left: clamp(20px, 4vw, 40px);
  z-index: 15;
  display: flex;
  flex-direction: row;
  align-items: flex-start;
  gap: clamp(15px, 3vw, 24px);
}

/* UNIFIED BUTTON SIZING - ALL BUTTONS SAME SIZE */
#dropdownToggle,
#aBtn,
#gujaratiBtn,
#shapesBtn {
  width: clamp(60px, 10vw, 80px) !important;
  height: clamp(60px, 10vw, 80px) !important;
  border-radius: 50%;
  border: 2px solid #666;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: clamp(1.2rem, 2vw, 1.8rem);
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

#dropdownToggle {
  background: linear-gradient(135deg, #ff179e, #9855fe, #45a0fc);
  color: white;
}

#aBtn {
  background-color: #000;
  color: white;
}

#gujaratiBtn {
  background-color: #000;
  color: #fff;
  font-family: 'Gopika', 'Noto Sans Gujarati', sans-serif !important;
}

#shapesBtn {
  background-color: #000000;
  color: #000000;
  border: 2px solid #999;
}

#dropdownToggle:hover,
#aBtn:hover,
#gujaratiBtn:hover,
#shapesBtn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
  border: 3px solid #ffb700 !important;
}

/* VERTICAL DROPDOWN MENU - NO TITLES, ALL ELEMENTS VERTICALLY */
#dropdownMenu {
  position: absolute;
  top: calc(100% + 15px);
  left: 0;
  opacity: 0;
  visibility: hidden;
  transition: all 0.3s ease;
  pointer-events: none;
  background: rgba(255, 255, 255, 0.95);
  border-radius: 20px;
  padding: 15px;
  box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  backdrop-filter: blur(10px);
  min-width: 80px;
  max-height: 60vh;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 12px;
}

#dropdownMenu.open {
  opacity: 1;
  visibility: visible;
  pointer-events: all;
}

/* Scrollbar styling */
#dropdownMenu::-webkit-scrollbar {
  width: 6px;
}

#dropdownMenu::-webkit-scrollbar-track {
  background: rgba(0,0,0,0.1);
  border-radius: 3px;
}

#dropdownMenu::-webkit-scrollbar-thumb {
  background: #ff179e;
  border-radius: 3px;
}

#dropdownMenu::-webkit-scrollbar-thumb:hover {
  background: #d1147a;
}

.dropdown-item {
  position: relative;
  width: clamp(50px, 8vw, 60px);
  height: clamp(50px, 8vw, 60px);
  border-radius: 50%;
  border: 2px solid #ccc;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(0.8rem, 1.4vw, 1.2rem);
  color: white;
  font-family: "CLT Apfel Grotezk", sans-serif !important;
  font-weight: bold;
  user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}

.dropdown-item:hover {
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  border: 3px solid #ffb700 !important;
}

.dropdown-item.selected,
#dropdownToggle.selected,
#aBtn.selected,
#gujaratiBtn.selected,
#shapesBtn.selected {
  border: 3px solid #ffb700 !important;
  box-shadow: 0 0 15px #ffb700, 0 0 25px #ffb700, 0 0 35px #ffb700 !important;
}

/* Vertical brush size slider */
#brushSizeContainer {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: rgba(255, 192, 203, 0.2);
  border-radius: 15px;
  border: 2px solid rgb(255, 0, 221);
  backdrop-filter: blur(10px);
}

/* A Mode Cancel Button */
#aCancelBtn {
  position: fixed;
  top: clamp(20px, 4vh, 40px);
  right: clamp(20px, 4vw, 40px);
  width: clamp(50px, 8vw, 70px);
  height: clamp(50px, 8vw, 70px);
  border-radius: 50%;
  background: linear-gradient(45deg, #000 0%, #000 49%, #fff 49%, #fff 51%, #000 51%);
  border: 3px solid #666;
  color: white;
  font-size: clamp(1.2rem, 2vw, 1.8rem);
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,0.3);
  display: none;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  z-index: 20;
}

#aCancelBtn:hover {
  transform: scale(1.1);
  box-shadow: 0 6px 20px rgba(0,0,0,0.4);
}

/* Letter Grid Modal */
#letterGridModal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: rgba(0, 0, 0, 0.8);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000 !important;
}

#letterGrid {
  background: white;
  border-radius: 20px;
  padding: 20px;
  max-width: 90vw;
  max-height: 80vh;
  overflow-y: auto;
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 10px;
  position: relative;
}

.letter-item {
  width: clamp(60px, 8vw, 80px);
  height: clamp(60px, 8vw, 80px);
  border: 2px solid #ccc;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: clamp(1rem, 2vw, 1.5rem);
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  background: white;
  color: #333;
  font-family: "comic-sans-ms", sans-serif !important;
  font-weight: 400 !important;
  font-style: normal !important;
}

.letter-item:hover {
  transform: scale(1.1);
  border-color: #ff179e;
  background: #f0f0f0;
}

#closeLetterGrid {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 40px;
  height: 40px;
  border: none;
  background: #ff179e;
  color: white;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10;
}

/* Color button styles */
.pink { background-color: rgb(255, 0, 221); }
.purple { background-color: rgb(92, 0, 157); }
.yellow { background-color: rgb(255, 187, 0); }
.orange { background-color: rgb(255, 77, 0); }
.blue { background-color: rgb(125, 244, 255); }

.gradient { 
  background: radial-gradient(circle, 
    rgb(255, 0, 221) 0%, 
    rgb(92, 0, 157) 20%, 
    rgb(255, 187, 0) 40%, 
    rgb(255, 77, 0) 60%, 
    rgb(125, 244, 255) 80%,
    rgb(255, 0, 221) 100%);
  position: relative;
  overflow: hidden;
}

.gradient::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: radial-gradient(circle, 
    rgb(255, 0, 221) 0%, 
    rgb(92, 0, 157) 20%, 
    rgb(255, 187, 0) 40%, 
    rgb(255, 77, 0) 60%, 
    rgb(125, 244, 255) 80%,
    rgb(255, 0, 221) 100%);
  animation: gradientShift 3s ease-in-out infinite;
  border-radius: 50%;
}

@keyframes gradientShift {
  0%, 100% { transform: rotate(0deg) scale(1); }
  50% { transform: rotate(180deg) scale(1.1); }
}

.eraser { 
  background-color: #f0f0f0; 
  color: #333;
  border: 3px solid #999;
}

/* Vertical brush size slider */
#brushSizeSlider {
  -webkit-appearance: slider-vertical;
  writing-mode: bt-lr; /* IE */
  -webkit-writing-mode: bt-lr; /* Webkit */
  writing-mode: vertical-lr; /* Standard */
  width: 6px;
  height: 80px;
  border-radius: 3px;
  background: linear-gradient(to top, rgb(255, 0, 221), rgb(255, 100, 200));
  outline: none;
  opacity: 0.9;
  transition: opacity 0.2s;
}

#brushSizeSlider:hover {
  opacity: 1;
}

#brushSizeSlider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgb(255, 0, 221);
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
}

#brushSizeSlider::-webkit-slider-thumb:hover {
  transform: scale(1.1);
}

#brushSizeSlider::-moz-range-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: rgb(255, 0, 221);
  cursor: pointer;
  border: none;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
  transition: transform 0.2s ease;
}

#brushSizeSlider::-moz-range-thumb:hover {
  transform: scale(1.1);
}

#brushSizeLabel {
  font-size: clamp(0.6rem, 1vw, 1rem);
  font-weight: bold;
  color: rgb(255, 0, 221);
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

#mainResetBtn {
  position: fixed;
  bottom: clamp(10px, 3vh, 25px);
  right: clamp(10px, 3vw, 25px);
  background: linear-gradient(90deg, #ff179e, #9855fe, #45a0fc);
  color: rgb(0, 0, 0);
  z-index: 10;
  padding: clamp(0.4rem, 0.6rem, 0.8rem) clamp(0.6rem, 1rem, 1.2rem);
  font-weight: bold;
  border: none;
  border-radius: 15px;
  font-size: clamp(0.7rem, 1rem, 1.1rem);
  cursor: pointer;
}

#mainResetBtn:hover {
  transform: scale(1.05);
  background: linear-gradient(90deg, #c1ff3c, #55fef8,#45a0fc);
  color: rgb(255, 255, 255);
}

#cameraBtn {
  position: fixed;
  bottom: clamp(10px, 3vh, 25px);
  left: clamp(10px, 3vw, 25px);
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  z-index: 10;
  padding: clamp(0.4rem, 0.6rem, 0.8rem) clamp(0.6rem, 1rem, 1.2rem);
  font-weight: bold;
  border: none;
  border-radius: 15px;
  font-size: clamp(0.7rem, 1rem, 1.1rem);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
}

#cameraBtn:hover {
  transform: scale(1.05);
  background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
}

.hidden {
  display: none;
}

/* Enable Sound Button - prominently positioned */
#enableSoundBtn {
  position: fixed;
  top: 16px;
  right: 12px;
  left: auto;
  transform: none;
  background: linear-gradient(135deg, #ffb700, #ffb700);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 6px 14px;
  font-size: 0.95rem;
  font-weight: bold;
  cursor: pointer;
  box-shadow: 0 2px 8px rgba(0,0,0,0.18);
  z-index: 2000;
  display: none;
  animation: none;
}

@keyframes pulse {
  0%, 100% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.05); }
}

/* RESPONSIVE ADJUSTMENTS - MAINTAIN EQUAL SIZING */
@media (max-width: 900px) {
  #buttonContainer {
    top: clamp(60px, 10vh, 80px);
    left: clamp(10px, 2vw, 20px);
    gap: clamp(10px, 2vw, 15px);
  }
  
  #dropdownToggle,
  #aBtn,
  #gujaratiBtn,
  #shapesBtn {
    width: clamp(50px, 8vw, 65px) !important;
    height: clamp(50px, 8vw, 65px) !important;
    font-size: clamp(1rem, 1.6vw, 1.4rem) !important;
  }
  
  #dropdownMenu {
    min-width: 70px;
    padding: 12px;
  }
  
  .dropdown-item {
    width: clamp(40px, 6vw, 50px);
    height: clamp(40px, 6vw, 50px);
    font-size: clamp(0.7rem, 1.2vw, 1rem);
  }
  
  #letterGrid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  #gujaratiGrid {
    grid-template-columns: repeat(8, 1fr);
  }
}

@media (max-width: 600px) {
  #buttonContainer {
    top: clamp(50px, 8vh, 60px);
    left: clamp(5px, 1vw, 10px);
    gap: clamp(8px, 1.5vw, 12px);
  }
  
  #dropdownToggle,
  #aBtn,
  #gujaratiBtn,
  #shapesBtn {
    width: clamp(45px, 7vw, 55px) !important;
    height: clamp(45px, 7vw, 55px) !important;
    font-size: clamp(0.9rem, 1.4vw, 1.2rem) !important;
  }
  
  #dropdownMenu {
    min-width: 60px;
    padding: 10px;
  }
  
  .dropdown-item {
    width: clamp(35px, 5vw, 45px);
    height: clamp(35px, 5vw, 45px);
    font-size: clamp(0.6rem, 1vw, 0.9rem);
  }
  
  #letterGrid {
    grid-template-columns: repeat(4, 1fr);
  }
  
  #gujaratiGrid {
    grid-template-columns: repeat(8, 1fr);
  }
  
  #shapesGrid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (orientation: landscape) and (max-height: 600px) {
  #buttonContainer {
    top: clamp(30px, 6vh, 50px);
    left: clamp(5px, 1vw, 10px);
    gap: clamp(6px, 1vw, 10px);
  }
  
  #dropdownToggle,
  #aBtn,
  #gujaratiBtn,
  #shapesBtn {
    width: clamp(40px, 6vw, 50px) !important;
    height: clamp(40px, 6vw, 50px) !important;
    font-size: clamp(0.8rem, 1.2vw, 1rem) !important;
  }
  
  #dropdownMenu {
    max-height: 50vh;
    min-width: 50px;
  }
}
  </style>
</head>
<body>

  <div id="prompt">Paint, Gradient, Erase, A/a Mode, Scrape.</div>

  <div id="title">Draw, Hide, and Scratch to reveal!</div>
  
  <!-- FIXED BUTTON CONTAINER -->
  <div id="buttonContainer">
    <button id="dropdownToggle">☰</button>
    <button id="aBtn">A/a</button>
    <button id="gujaratiBtn">ક</button>
    <button id="shapesBtn">
      <span style="display:inline-block;width:2.5em;height: 2.5em;background:#000;border-radius:50%;position:relative;">
        <svg width="100%" height="100%" viewBox="0 0 40 40" style="position:absolute;top:0;left:0;">
          <circle cx="20" cy="20" r="16" stroke="#fff" stroke-width="3" fill="none" />
          <circle cx="20" cy="20" r="10" fill="#000" stroke="none" />
        </svg>
      </span>
    </button>
    
    <!-- VERTICAL DROPDOWN MENU - NO TITLES -->
    <div id="dropdownMenu">
      <!-- Colors arranged vertically -->
      <button class="dropdown-item pink" data-color="rgb(255, 0, 221)"></button>
      <button class="dropdown-item purple" data-color="rgb(92, 0, 157)"></button>
      <button class="dropdown-item yellow" data-color="rgb(255, 187, 0)"></button>
      <button class="dropdown-item orange" data-color="rgb(255, 77, 0)"></button>
      <button class="dropdown-item blue" data-color="rgb(125, 244, 255)"></button>
      
      <!-- Tools arranged vertically -->
      <button class="dropdown-item gradient" id="gradientBtn">🌈</button>
      <button class="dropdown-item eraser" id="eraserBtn" style="padding:0;display:flex;align-items:center;justify-content:center;">
        <span style="display:inline-block;width:22px;height:22px;background:#000;border-radius:3px;position:relative;">
          <span style="display:block;position:absolute;left:8px;top:2px;width:6px;height:18px;background:#fff;border-radius:2px;"></span>
        </span>
      </button>
      
      <!-- Vertical Brush Size Slider -->
      <div id="brushSizeContainer">
        <input type="range" id="brushSizeSlider" min="5" max="50" value="30" step="1" orient="vertical">
        <span id="brushSizeLabel">30px</span>
      </div>
    </div>
  </div>

  <!-- Letter Grid Modal -->
  <div id="letterGridModal">
    <div id="letterGrid">
      <button id="closeLetterGrid">✕</button>
    </div>
  </div>
  <!-- Gujarati Grid Modal -->
  <div id="gujaratiGridModal">
    <div id="gujaratiGrid">
      <button id="closeGujaratiGrid">✕</button>
    </div>
  </div>

  <!-- Shapes Grid Modal -->
  <div id="shapesGridModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:1000;">
    <div id="shapesGrid" style="background:white;border-radius:22px;padding:40px 20px 20px 20px;max-width:90vw;max-height:80vh;overflow-y:auto;display:grid;grid-template-columns:repeat(3,1fr);gap:16px;position:relative;">
      <button id="closeShapesGrid" style="position:fixed;top:20px;right:20px;width:40px;height:40px;border:none;background:#ffb700;color:white;border-radius:50%;font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:1001;">✕</button>
      <!-- Shape buttons will be injected here -->
    </div>
  </div>

  <!-- A Mode Cancel Button -->
  <button id="aCancelBtn">✕</button>

  <button id="mainResetBtn">Reset</button>
  <button id="cameraBtn">Save</button>
  <canvas id="colorCanvas"></canvas>
  <!-- Stencil overlay canvas (same as aOverlay, reused for stencil mode) -->
  <canvas id="aOverlay"></canvas>
  <button id="stencilCloseBtn"></button>
  <button id="enableSoundBtn">🎵 Enable Sound</button>

  <script>
// --- ROBUST MOBILE AUDIO SYSTEM ---
let audioInitialized = false;
let audioUnlocked = false;
let pendingAudioInit = false;
let synth = null;
const enableSoundBtn = document.getElementById('enableSoundBtn');

// Device detection
function isMobileDevice() {
  return /iPhone|iPad|iPod|Android|webOS|BlackBerry|Windows Phone/i.test(navigator.userAgent);
}

// Show/Hide enable sound button
function showEnableSoundBtn() {
  enableSoundBtn.style.display = 'block';
  console.log('Showing enable sound button');
}

function hideEnableSoundBtn() {
  enableSoundBtn.style.display = 'none';
  console.log('Hiding enable sound button');
}

// Comprehensive audio context unlock
async function unlockAudioContext() {
  if (audioUnlocked || pendingAudioInit) return true;
  
  pendingAudioInit = true;
  console.log('Attempting to unlock audio context...');
  
  try {
    if (!window.Tone || !Tone.context) {
      console.log('Tone.js not available');
      return false;
    }

    // Start Tone.js context if suspended
    if (Tone.context.state === 'suspended') {
      await Tone.start();
      console.log('Tone.js context started');
    }
    
    // Create silent buffer to fully unlock
    const buffer = Tone.context.createBuffer(1, 1, 22050);
    const source = Tone.context.createBufferSource();
    source.buffer = buffer;
    source.connect(Tone.context.destination);
    source.start(0);
    
    // Create oscillator for additional unlock
    const osc = Tone.context.createOscillator();
    osc.connect(Tone.context.destination);
    osc.start(0);
    osc.stop(0.01);
    
    audioUnlocked = true;
    console.log('Audio context unlocked successfully');
    return true;
    
  } catch (error) {
    console.warn('Audio unlock failed:', error);
    return false;
  } finally {
    pendingAudioInit = false;
  }
}

// Initialize audio with retry mechanism
async function initAudio(retries = 5) {
  if (audioInitialized) {
    console.log('Audio already initialized');
    return true;
  }
  
  console.log('Initializing audio...');
  
  // First unlock the audio context
  let unlocked = false;
  for (let i = 0; i < retries && !unlocked; i++) {
    unlocked = await unlockAudioContext();
    if (!unlocked) {
      await new Promise(resolve => setTimeout(resolve, 200));
    }
  }
  
  if (!unlocked) {
    console.log('Audio unlock failed, showing enable button');
    showEnableSoundBtn();
    return false;
  }
  
  try {
    // Create synth after successful unlock
    if (synth) {
      synth.dispose();
    }
    synth = new Tone.AMSynth().toDestination();
    
    audioInitialized = true;
    hideEnableSoundBtn();
    // Play test beep (C4, then E4) to confirm audio
    try {
      await Tone.start();
      synth.triggerAttackRelease('C4', '8n');
      setTimeout(() => synth.triggerAttackRelease('E4', '8n'), 350);
    } catch (err) {
      console.warn('Test beep failed:', err);
    }
    console.log('Audio initialization complete');
    return true;
    
  } catch (error) {
    console.error('Synth creation failed:', error);
    showEnableSoundBtn();
    return false;
  }
}

// Enable sound button handler
enableSoundBtn.addEventListener('click', async (e) => {
  e.preventDefault();
  e.stopPropagation();
  enableSoundBtn.style.display = 'none';
  console.log('Enable sound button clicked');
  await initAudio(5);
});

enableSoundBtn.addEventListener('touchend', async (e) => {
  e.preventDefault();
  e.stopPropagation();
  enableSoundBtn.style.display = 'none';
  console.log('Enable sound button touched');
  await initAudio(5);
});

// Multiple event listeners for cross-platform compatibility
const audioInitEvents = ['touchstart', 'touchend', 'mousedown', 'keydown', 'click'];
audioInitEvents.forEach(eventType => {
  document.addEventListener(eventType, () => {
    if (!audioInitialized) {
      initAudio(3);
    }
  }, { once: true, passive: true });
});

// Show enable button on mobile by default
if (isMobileDevice()) {
  setTimeout(showEnableSoundBtn, 1000);
} else {
  // Try to initialize immediately on desktop
  setTimeout(() => initAudio(2), 500);
}

// Handle visibility changes (app backgrounded/foregrounded)
document.addEventListener('visibilitychange', async () => {
  if (!document.hidden && audioInitialized && Tone.context && Tone.context.state === 'suspended') {
    try {
      await Tone.start();
      console.log('Audio context resumed after visibility change');
    } catch (error) {
      console.warn('Failed to resume audio context:', error);
    }
  }
});

// --- END ROBUST MOBILE AUDIO SYSTEM ---

// Gujarati letters, vowels, numerals
const gujaratiConsonants = [
  'ક','ખ','ગ','ઘ','ઙ','ચ','છ','જ','ઝ','ઞ','ટ','ઠ',
  'ડ','ઢ','ણ','ત','થ','દ','ધ','ન','પ','ફ','બ','ભ',
  'મ','ય','ર','લ','વ','શ','ષ','સ','હ','ળ','ક્ષ','ત્ર'
];
const gujaratiVowels = ['અ','આ','ઇ','ઈ','ઉ','ઊ','એ','ઐ','ઓ','ઔ','અં','અઃ'];
const gujaratiNumerals = ['૦','૧','૨','૩','૪','૫','૬','૭','૮','૯'];

// Show Gujarati grid modal
document.getElementById('gujaratiBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('letterGridModal').style.display = 'none';
  createGujaratiGrid();
  document.getElementById('gujaratiGridModal').style.display = 'flex';
});
document.getElementById('gujaratiBtn').addEventListener('touchend', function(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('letterGridModal').style.display = 'none';
  createGujaratiGrid();
  document.getElementById('gujaratiGridModal').style.display = 'flex';
});

// Show A/a grid modal
document.getElementById('aBtn').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('gujaratiGridModal').style.display = 'none';
  document.getElementById('letterGridModal').style.display = 'flex';
});
document.getElementById('aBtn').addEventListener('touchend', function(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('gujaratiGridModal').style.display = 'none';
  document.getElementById('letterGridModal').style.display = 'flex';
});

// Close Gujarati grid
document.getElementById('closeGujaratiGrid').addEventListener('click', function(e) {
  e.preventDefault();
  e.stopPropagation();
  document.getElementById('gujaratiGridModal').style.display = 'none';
});

// Create Gujarati grid
function createGujaratiGrid() {
  const gujaratiGrid = document.getElementById('gujaratiGrid');
  const closeBtn = document.getElementById('closeGujaratiGrid');
  gujaratiGrid.innerHTML = '';
  gujaratiGrid.appendChild(closeBtn);
  
  // Consonants
  gujaratiConsonants.forEach(char => {
    const item = document.createElement('button');
    item.className = 'gujarati-item';
    item.textContent = char;
    item.addEventListener('click', () => showGujaratiStencilOverlay(char));
    gujaratiGrid.appendChild(item);
  });
  
  // Vowels
  gujaratiVowels.forEach(char => {
    const item = document.createElement('button');
    item.className = 'gujarati-item';
    item.textContent = char;
    item.addEventListener('click', () => showGujaratiStencilOverlay(char));
    gujaratiGrid.appendChild(item);
  });
  
  // Numerals
  gujaratiNumerals.forEach(char => {
    const item = document.createElement('button');
    item.className = 'gujarati-item';
    item.textContent = char;
    item.addEventListener('click', () => showGujaratiStencilOverlay(char));
    gujaratiGrid.appendChild(item);
  });
}

// Show Gujarati stencil overlay
function showGujaratiStencilOverlay(char) {
  isStencilMode = true;
  selectedLetter = char;
  document.getElementById('gujaratiGridModal').style.display = 'none';
  drawGujaratiStencilOverlay(char);
  stencilCloseBtn.style.display = 'flex';
  aOverlay.style.display = 'block';
  document.getElementById('buttonContainer').style.zIndex = 40;
  document.getElementById('mainResetBtn').style.zIndex = 40;
  document.getElementById('cameraBtn').style.zIndex = 40;
  document.getElementById('title').style.zIndex = 40;
  document.getElementById('prompt').style.zIndex = 40;
}

// Draw Gujarati stencil overlay
function drawGujaratiStencilOverlay(char) {
  aOverlay.width = window.innerWidth;
  aOverlay.height = window.innerHeight;
  aCtx.clearRect(0, 0, aOverlay.width, aOverlay.height);
  aCtx.globalAlpha = 1.0;
  aCtx.fillStyle = 'black';
  aCtx.fillRect(0, 0, aOverlay.width, aOverlay.height);
  aCtx.save();
  aCtx.globalCompositeOperation = 'destination-out';
  let fontSize = Math.min(aOverlay.width, aOverlay.height) * 0.6;
  aCtx.font = `${fontSize}px 'Gopika', 'Noto Sans Gujarati', sans-serif`;
  aCtx.textAlign = 'center';
  aCtx.textBaseline = 'middle';
  aCtx.fillText(char, aOverlay.width/2, aOverlay.height/2);
  aCtx.restore();
  aCtx.globalCompositeOperation = 'source-over';
}

// --- Digital Stencil Feature ---
let isStencilMode = false;
const stencilCloseBtn = document.getElementById('stencilCloseBtn');

// Canvas and context setup
const colorCanvas = document.getElementById('colorCanvas');
const aOverlay = document.getElementById('aOverlay');
const ctx = colorCanvas.getContext('2d');
const aCtx = aOverlay.getContext('2d');
const backgroundImage = new Image();
let isTouchDevice = false;
let isAMode = false;
let aImage = null;
let selectedLetter = 'A';
let selectedButton = null;

// Detect touch device and initialize audio appropriately
if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
  isTouchDevice = true;
  console.log('Touch device detected');
}

// Show stencil overlay with transparent letter/digit
function showStencilOverlay(char) {
  isStencilMode = true;
  selectedLetter = char;
  document.getElementById('letterGridModal').style.display = 'none';
  drawStencilOverlay(char);
  stencilCloseBtn.style.display = 'flex';
  aOverlay.style.display = 'block';
  // Keep dropdown and UI visible
  document.getElementById('buttonContainer').style.zIndex = 40;
  document.getElementById('mainResetBtn').style.zIndex = 40;
  document.getElementById('cameraBtn').style.zIndex = 40;
  document.getElementById('title').style.zIndex = 40;
  document.getElementById('prompt').style.zIndex = 40;
}

// Draw stencil overlay: black everywhere, transparent where char is
function drawStencilOverlay(char) {
  aOverlay.width = window.innerWidth;
  aOverlay.height = window.innerHeight;
  aCtx.clearRect(0, 0, aOverlay.width, aOverlay.height);
  // Fill with black
  aCtx.globalAlpha = 1.0;
  aCtx.fillStyle = 'black';
  aCtx.fillRect(0, 0, aOverlay.width, aOverlay.height);
  // Draw transparent letter/digit
  aCtx.save();
  aCtx.globalCompositeOperation = 'destination-out';
  // Calculate font size and position
  let fontSize = Math.min(aOverlay.width, aOverlay.height) * 0.6;
  if (char.length > 1) fontSize *= 0.7;
  aCtx.font = `400 normal ${fontSize}px "comic-sans-ms", sans-serif`;
  aCtx.textAlign = 'center';
  aCtx.textBaseline = 'middle';
  aCtx.fillText(char, aOverlay.width/2, aOverlay.height/2);
  aCtx.restore();
  aCtx.globalCompositeOperation = 'source-over';
}

// Remove stencil overlay
function exitStencilMode() {
  isStencilMode = false;
  aOverlay.style.display = 'none';
  stencilCloseBtn.style.display = 'none';
  // Restore z-indexes
  document.getElementById('buttonContainer').style.zIndex = 15;
  document.getElementById('mainResetBtn').style.zIndex = 10;
  document.getElementById('cameraBtn').style.zIndex = 10;
  document.getElementById('title').style.zIndex = 10;
  document.getElementById('prompt').style.zIndex = 20;
}

// Stencil close button event
stencilCloseBtn.addEventListener('click', function(e) {
  e.preventDefault();
  exitStencilMode();
});
stencilCloseBtn.addEventListener('touchend', function(e) {
  e.preventDefault();
  exitStencilMode();
});

// Create letter grid
function createLetterGrid() {
  const letterGrid = document.getElementById('letterGrid');
  const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
  const numbers = '0123456789';
  
  // Clear existing content except close button
  const closeBtn = document.getElementById('closeLetterGrid');
  letterGrid.innerHTML = '';
  letterGrid.appendChild(closeBtn);
  
  // Add letters
  for (let i = 0; i < letters.length; i++) {
    const letter = letters[i];
    const letterItem = document.createElement('button');
    letterItem.className = 'letter-item';
    letterItem.textContent = letter + letter.toLowerCase();
    letterItem.addEventListener('click', () => showStencilOverlay(letter + letter.toLowerCase()));
    letterGrid.appendChild(letterItem);
  }
  
  // Add numbers
  for (let i = 0; i < numbers.length; i++) {
    const number = numbers[i];
    const numberItem = document.createElement('button');
    numberItem.className = 'letter-item';
    numberItem.textContent = number;
    numberItem.addEventListener('click', () => showStencilOverlay(number));
    letterGrid.appendChild(numberItem);
  }
}

// Create A image from the selected letter
function createAImage() {
  return new Promise((resolve) => {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    // Set canvas size
    canvas.width = 1000;
    canvas.height = 1000;
    
    // Fill with transparent
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Create the selected letter/number
    ctx.fillStyle = 'white';
    ctx.font = '400 normal 600px "comic-sans-ms", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText(selectedLetter, canvas.width/2, canvas.height/2);
    
    const img = new Image();
    img.onload = () => resolve(img);
    img.src = canvas.toDataURL();
  });
}

// Initialize letter grid and A image
createLetterGrid();
createAImage().then(img => {
  aImage = img;
});

// Create a fallback white background
function createWhiteBackground() {
  ctx.fillStyle = 'white';
  ctx.fillRect(0, 0, colorCanvas.width, colorCanvas.height);
}

backgroundImage.src = 'white-wall.jpg';
backgroundImage.onerror = function() {
  createWhiteBackground();
};

backgroundImage.onload = function() {
  ctx.drawImage(backgroundImage, 0, 0, colorCanvas.width, colorCanvas.height);
};

function resizeCanvasDimensions() {
  colorCanvas.width = aOverlay.width = window.innerWidth;
  colorCanvas.height = aOverlay.height = window.innerHeight;
  
  if (backgroundImage.complete && backgroundImage.naturalWidth > 0) {
    ctx.drawImage(backgroundImage, 0, 0, colorCanvas.width, colorCanvas.height);
  } else {
    createWhiteBackground();
  }
  
  // Redraw A overlay if in A mode
  if (isAMode && aImage) {
    drawAOverlay();
  }
  
  // Redraw stencil overlay if active
  if (isStencilMode && selectedLetter) {
    if (selectedLetter.match(/[\u0A80-\u0AFF]/)) {
      drawGujaratiStencilOverlay(selectedLetter);
    } else {
      drawStencilOverlay(selectedLetter);
    }
  }
}

function drawAOverlay() {
  aCtx.clearRect(0, 0, aOverlay.width, aOverlay.height);
  
  // Fill entire canvas with black
  aCtx.fillStyle = 'black';
  aCtx.fillRect(0, 0, aOverlay.width, aOverlay.height);
  
  // Calculate scaling to fit image in canvas while maintaining aspect ratio
  const scale = Math.min(aOverlay.width / aImage.width, aOverlay.height / aImage.height) * 0.8;
  const scaledWidth = aImage.width * scale;
  const scaledHeight = aImage.height * scale;
  const x = (aOverlay.width - scaledWidth) / 2;
  const y = (aOverlay.height - scaledHeight) / 2;
  
  // Use destination-out to create transparent areas where the letter image is
  aCtx.globalCompositeOperation = 'destination-out';
  aCtx.drawImage(aImage, x, y, scaledWidth, scaledHeight);
  aCtx.globalCompositeOperation = 'source-over';
}

function setSelectedButton(button) {
  // Remove selection from previous button
  if (selectedButton) {
    selectedButton.classList.remove('selected');
  }
  
  // Add selection to new button
  if (button) {
    button.classList.add('selected');
    selectedButton = button;
  }
}

function setAMode() {
  initAudio(); // Ensure audio is ready
  isAMode = true;
  isGradientMode = false;
  isEraserMode = false;
  aOverlay.style.display = 'block';
  document.getElementById('aCancelBtn').style.display = 'flex';
  setSelectedButton(document.getElementById('aBtn'));
  if (aImage) {
    drawAOverlay();
  }
  console.log('A mode activated with letter:', selectedLetter);
}

function exitAMode() {
  isAMode = false;
  aOverlay.style.display = 'none';
  document.getElementById('aCancelBtn').style.display = 'none';
  if (selectedButton === document.getElementById('aBtn')) {
    setSelectedButton(null);
  }
}

resizeCanvasDimensions();
window.addEventListener('resize', resizeCanvasDimensions);

// Drawing variables
let painting = false;
let currentColor = 'rgb(255, 0, 221)';
let isGradientMode = false;
let isEraserMode = false;
let gradientColors = [];
let gradientIndex = 0;
let colorTimer = 0;
let colorDuration = 500;
let lastColorChangeTime = 0;
let currentGradientColor = null;
let nextGradientColor = null;
let colorTransitionProgress = 0;
let brushSize = 30;
let eraserAudioTimer = 0;
let lastPlayedNote = null;
let noteChangeThreshold = 80;
let eraserMoving = false;
let eraserPath = [];

// Audio-related variables
let currentNote = null;
let noteScheduler = null;
let playingNotes = new Set();

const colorNotes = {
  pink: "C4",
  purple: "D4",
  yellow: "E4",
  orange: "F4",
  blue: "G4"
};

const colors = [
  { name: 'pink', rgb: 'rgb(255, 0, 221)', r: 255, g: 0, b: 221 },
  { name: 'purple', rgb: 'rgb(92, 0, 157)', r: 92, g: 0, b: 157 },
  { name: 'yellow', rgb: 'rgb(255, 187, 0)', r: 255, g: 187, b: 0 },
  { name: 'orange', rgb: 'rgb(255, 77, 0)', r: 255, g: 77, b: 0 },
  { name: 'blue', rgb: 'rgb(125, 244, 255)', r: 125, g: 244, b: 255 }
];

// Audio functions
function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

async function playNote(colorName) {
  if (!audioInitialized || !synth) {
    console.log('Audio not ready, attempting to initialize...');
    await initAudio();
    if (!audioInitialized) return;
  }

  const note = colorNotes[colorName];
  if (note) {
    try {
      if (isGradientMode) {
        synth.triggerAttackRelease(note, "4n");
      } else {
        synth.triggerAttackRelease(note, "8n");
      }
      console.log('Playing note:', note, 'for color:', colorName);
    } catch (error) {
      console.warn('Audio playback error:', error);
      // Try to reinitialize audio
      audioInitialized = false;
      await initAudio();
    }
  }
}

function setColor(color, button) {
  initAudio(); // Ensure audio is ready
  currentColor = color;
  isGradientMode = false;
  isEraserMode = false;
  setSelectedButton(button);
  console.log('Color set to:', color);
}

function setGradientMode(button) {
  initAudio(); // Ensure audio is ready
  isGradientMode = true;
  isEraserMode = false;
  setSelectedButton(button);
  gradientColors = shuffleArray(colors);
  gradientIndex = 0;
  colorTimer = 0;
  lastColorChangeTime = Date.now();
  currentGradientColor = gradientColors[0];
  nextGradientColor = gradientColors[1];
  colorTransitionProgress = 0;
  console.log('Gradient mode activated with colors:', gradientColors);
}

function setEraserMode(button) {
  initAudio(); // Ensure audio is ready
  isEraserMode = true;
  isGradientMode = false;
  setSelectedButton(button);
  console.log('Eraser mode activated');
}

function resetCanvas() {
  ctx.clearRect(0, 0, colorCanvas.width, colorCanvas.height);
  if (backgroundImage.complete && backgroundImage.naturalWidth > 0) {
    ctx.drawImage(backgroundImage, 0, 0, colorCanvas.width, colorCanvas.height);
  } else {
    createWhiteBackground();
  }
  
  if (isAMode) {
    exitAMode();
  }
}

// Enhanced capture function with better mobile support
function captureCanvas() {
  const tempCanvas = document.createElement('canvas');
  const tempCtx = tempCanvas.getContext('2d');
  
  tempCanvas.width = colorCanvas.width;
  tempCanvas.height = colorCanvas.height;
  
  // Always draw the background first
  if (backgroundImage.complete && backgroundImage.naturalWidth > 0) {
    tempCtx.drawImage(backgroundImage, 0, 0, tempCanvas.width, tempCanvas.height);
  } else {
    tempCtx.fillStyle = 'white';
    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
  }
  
  // Draw only the colored strokes (transparent where erased)
  tempCtx.drawImage(colorCanvas, 0, 0);
  
  // Overlay stencil/A mode if active
  if ((isAMode || isStencilMode) && aOverlay.style.display !== 'none') {
    tempCtx.drawImage(aOverlay, 0, 0);
  }
  
  const now = new Date();
  const timestamp = now.getFullYear() + 
    String(now.getMonth() + 1).padStart(2, '0') + 
    String(now.getDate()).padStart(2, '0') + '_' +
    String(now.getHours()).padStart(2, '0') + 
    String(now.getMinutes()).padStart(2, '0') + 
    String(now.getSeconds()).padStart(2, '0');
  
  // Enhanced mobile save handling
  if (isMobileDevice()) {
    tempCanvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      
     // Try Web Share API first (works on many mobile browsers)
      if (navigator.share && navigator.canShare && navigator.canShare({files: [new File([blob], `drawing_${timestamp}.png`, {type: 'image/png'})]})) {
        const file = new File([blob], `drawing_${timestamp}.png`, {type: 'image/png'});
        navigator.share({
          files: [file],
          title: 'My Drawing',
          text: 'Check out my drawing!'
        }).catch(error => {
          console.log('Web Share failed, falling back to image display');
          showImageForSave(url, timestamp);
        });
      } else {
        showImageForSave(url, timestamp);
      }
    }, 'image/png', 1.0);
  } else {
    // Desktop - direct download
    tempCanvas.toBlob(function(blob) {
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `drawing_${timestamp}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }, 'image/png', 1.0);
  }

}function showImageForSave(url, timestamp) {
  // Create overlay for image display
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0,0,0,0.9);
    z-index: 2000;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
    box-sizing: border-box;
  `;
  
  const img = document.createElement('img');
  img.src = url;
  img.style.cssText = `
    max-width: 90%;
    max-height: 70%;
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(255,255,255,0.1);
  `;
  
  const instructions = document.createElement('div');
  instructions.style.cssText = `
    color: white;
    text-align: center;
    font-size: 1.2rem;
    margin-top: 20px;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    line-height: 1.4;
  `;
  
  if (/iPhone|iPad|iPod/i.test(navigator.userAgent)) {
    instructions.innerHTML = `
      <strong>To save your drawing:</strong><br>
      1. Press and hold the image above<br>
      2. Tap "Save to Photos" or "Add to Photos"
    `;
  } else {
    instructions.innerHTML = `
      <strong>To save your drawing:</strong><br>
      1. Press and hold the image above<br>
      2. Select "Download image" or "Save image"
    `;
  }
  
  const closeBtn = document.createElement('button');
  closeBtn.textContent = '✕ Close';
  closeBtn.style.cssText = `
    position: absolute;
    top: 20px;
    right: 20px;
    background: #ff4444;
    color: white;
    border: none;
    border-radius: 25px;
    padding: 10px 20px;
    font-size: 1rem;
    cursor: pointer;
    font-weight: bold;
  `;
  
  closeBtn.onclick = () => {
    document.body.removeChild(overlay);
    URL.revokeObjectURL(url);
  };
  
  overlay.appendChild(img);
  overlay.appendChild(instructions);
  overlay.appendChild(closeBtn);
  document.body.appendChild(overlay);
  
  // Auto-close after 30 seconds
  setTimeout(() => {
    if (document.body.contains(overlay)) {
      document.body.removeChild(overlay);
      URL.revokeObjectURL(url);
    }
  }, 30000);
}
   document.getElementById('cameraBtn').onclick = function(e) {
  e.preventDefault();
  console.log('cameraBtn clicked');
  captureCanvas();
};

// Also add touch event for better mobile support
document.getElementById('cameraBtn').addEventListener('touchend', function(e) {
  e.preventDefault();
  e.stopPropagation();
  console.log('cameraBtn touched');
  captureCanvas();
});

    function getColorAtPixel(x, y) {
      const pixel = ctx.getImageData(x, y, 1, 1).data;
      const r = pixel[0], g = pixel[1], b = pixel[2], a = pixel[3];
      
      if (a === 0) return null;
      
      // Don't erase white background - check if it's close to white
      if (r > 240 && g > 240 && b > 240) return null;
      
      if (r === 255 && g === 0 && b === 221) return 'pink';
      if (r === 92 && g === 0 && b === 157) return 'purple';
      if (r === 255 && g === 187 && b === 0) return 'yellow';
      if (r === 255 && g === 77 && b === 0) return 'orange';
      if (r === 125 && g === 244 && b === 255) return 'blue';
      
      let closestColor = null;
      let minDistance = Infinity;
      
      for (const color of colors) {
        const distance = Math.sqrt(
          Math.pow(r - color.r, 2) + 
          Math.pow(g - color.g, 2) + 
          Math.pow(b - color.b, 2)
        );
        if (distance < minDistance) {
          minDistance = distance;
          closestColor = color.name;
        }
      }
      
      return minDistance < 100 ? closestColor : null;
    }

    async function playNote(colorName) {
      const note = colorNotes[colorName];
      if (note && audioInitialized && synth) {
        try {
          if (isGradientMode) {
            synth.triggerAttackRelease(note, "4n");
          } else {
            synth.triggerAttackRelease(note, "8n");
          }
        } catch (error) {
          console.log('Audio playback error:', error);
        }
      }
    }

    function interpolateColor(color1, color2, progress) {
      const r = Math.round(color1.r + (color2.r - color1.r) * progress);
      const g = Math.round(color1.g + (color2.g - color1.g) * progress);
      const b = Math.round(color1.b + (color2.b - color1.b) * progress);
      return `rgb(${r}, ${g}, ${b})`;
    }

    function updateGradientColor() {
      if (!isGradientMode) return currentColor;

      const now = Date.now();
      const elapsed = now - lastColorChangeTime;
      
      colorTransitionProgress = Math.min(elapsed / colorDuration, 1);
      
      if (colorTransitionProgress >= 1) {
        gradientIndex = (gradientIndex + 1) % gradientColors.length;
        currentGradientColor = gradientColors[gradientIndex];
        nextGradientColor = gradientColors[(gradientIndex + 1) % gradientColors.length];
        lastColorChangeTime = now;
        colorTransitionProgress = 0;
        
        playNote(currentGradientColor.name);
      }
      
      return interpolateColor(currentGradientColor, nextGradientColor, colorTransitionProgress);
    }

    function getColorNameFromRGB(rgbString) {
      const match = rgbString.match(/rgb\((\d+),\s*(\d+),\s*(\d+)\)/);
      if (!match) return null;
      
      const r = parseInt(match[1]);
      const g = parseInt(match[2]);
      const b = parseInt(match[3]);
      
      let closestColor = null;
      let minDistance = Infinity;
      
      for (const color of colors) {
        const distance = Math.sqrt(
          Math.pow(r - color.r, 2) + 
          Math.pow(g - color.g, 2) + 
          Math.pow(b - color.b, 2)
        );
        if (distance < minDistance) {
          minDistance = distance;
          closestColor = color.name;
        }
      }
      
      return closestColor;
    }

    function getRandomColorForEraser() {
      const randomIndex = Math.floor(Math.random() * colors.length);
      return colors[randomIndex].name;
    }

    function shouldPlayEraserAudio() {
      const now = Date.now();
      if (now - eraserAudioTimer > 60) {
        eraserAudioTimer = now;
        return true;
      }
      return false;
    }

    function playNoteIfDifferent(colorName, forcePlay = false) {
      const now = Date.now();
      if (colorName && (forcePlay || colorName !== lastPlayedNote || now - eraserAudioTimer > noteChangeThreshold)) {
        playNote(colorName);
        lastPlayedNote = colorName;
        return true;
      }
      return false;
    }

    function getDetailedColorSample(x, y, radius = 8) {
      const samples = [];
      const step = 2;
      
      for (let angle = 0; angle < 360; angle += 45) {
        const rad = (angle * Math.PI) / 180;
        const px = Math.round(x + Math.cos(rad) * radius);
        const py = Math.round(y + Math.sin(rad) * radius);
        
        if (px >= 0 && py >= 0 && px < colorCanvas.width && py < colorCanvas.height) {
          const color = getColorAtPixel(px, py);
          if (color) samples.push(color);
        }
      }
      
      const centerSamples = [
        [x, y], [x-1, y], [x+1, y], [x, y-1], [x, y+1]
      ];
      
      for (const [px, py] of centerSamples) {
        if (px >= 0 && py >= 0 && px < colorCanvas.width && py < colorCanvas.height) {
          const color = getColorAtPixel(px, py);
          if (color) samples.push(color);
        }
      }
      
      if (samples.length === 0) return null;
      
      const colorCounts = {};
      samples.forEach(color => {
        colorCounts[color] = (colorCounts[color] || 0) + 1;
      });
      
      return Object.keys(colorCounts).reduce((a, b) => 
        colorCounts[a] > colorCounts[b] ? a : b
      );
    }

    function maintainEraserAudio() {
      if (isEraserMode && painting && eraserMoving) {
        const lastPoint = eraserPath[eraserPath.length - 1];
        if (lastPoint) {
          const colorName = getDetailedColorSample(lastPoint.x, lastPoint.y);
          if (colorName) {
            const now = Date.now();
            if (now - eraserAudioTimer > 80 || colorName !== lastPlayedNote) {
              playNoteIfDifferent(colorName);
              eraserAudioTimer = now;
            }
          }
        }
      }
    }

    function draw(x, y) {
      if (!painting) return;
      // If stencil mode is active, only allow drawing inside the transparent area
      if (isStencilMode) {
        // Check if pixel is inside the letter/digit area by sampling overlay alpha
        const overlayPixel = aCtx.getImageData(x, y, 1, 1).data;
        // If overlay is transparent (alpha == 0), allow drawing
        if (overlayPixel[3] === 0) {
          if (isEraserMode) {
            eraserPath.push({x, y, timestamp: Date.now()});
            if (eraserPath.length > 10) {
              eraserPath.shift();
            }
            eraserMoving = true;
            const colorName = getDetailedColorSample(x, y, brushSize / 3);
            if (colorName) {
              const now = Date.now();
              const timeSinceLastNote = now - eraserAudioTimer;
              if (colorName !== lastPlayedNote || timeSinceLastNote > 60) {
                playNoteIfDifferent(colorName, timeSinceLastNote > 120);
              }
            }
            const imageData = ctx.getImageData(x - brushSize/2, y - brushSize/2, brushSize, brushSize);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
              const r = data[i];
              const g = data[i + 1];
              const b = data[i + 2];
              const a = data[i + 3];
              if (!(r > 240 && g > 240 && b > 240)) {
                const pixelIndex = i / 4;
                const pixelX = (pixelIndex % brushSize) - brushSize/2;
                const pixelY = Math.floor(pixelIndex / brushSize) - brushSize/2;
                const distance = Math.sqrt(pixelX * pixelX + pixelY * pixelY);
                if (distance <= brushSize/2) {
                  data[i + 3] = 0;
                }
              }
            }
            ctx.putImageData(imageData, x - brushSize/2, y - brushSize/2);
          } else if (isGradientMode) {
            const gradientColor = updateGradientColor();
            ctx.lineTo(x, y);
            ctx.strokeStyle = gradientColor;
            ctx.lineWidth = brushSize;
            ctx.lineCap = "round";
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
          } else {
            ctx.lineTo(x, y);
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = brushSize;
            ctx.lineCap = "round";
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(x, y);
            const colorName = getColorNameFromRGB(currentColor);
            if (colorName) playNote(colorName);
          }
        }
        // If not in transparent area, do nothing
        return;
      }
      // ...existing code for normal draw...
      if (isEraserMode) {
        eraserPath.push({x, y, timestamp: Date.now()});
        if (eraserPath.length > 10) {
          eraserPath.shift();
        }
        eraserMoving = true;
        const colorName = getDetailedColorSample(x, y, brushSize / 3);
        if (colorName) {
          const now = Date.now();
          const timeSinceLastNote = now - eraserAudioTimer;
          if (colorName !== lastPlayedNote || timeSinceLastNote > 60) {
            playNoteIfDifferent(colorName, timeSinceLastNote > 120);
          }
        }
        const imageData = ctx.getImageData(x - brushSize/2, y - brushSize/2, brushSize, brushSize);
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i + 1];
          const b = data[i + 2];
          const a = data[i + 3];
          // Only erase colored brush strokes, not white or background
          // If pixel is close to white, skip
          if (!(r > 240 && g > 240 && b > 240)) {
            // If pixel is not white and not fully background, erase it
            // This will erase gradients and blends too
            const pixelIndex = i / 4;
            const pixelX = (pixelIndex % brushSize) - brushSize/2;
            const pixelY = Math.floor(pixelIndex / brushSize) - brushSize/2;
            const distance = Math.sqrt(pixelX * pixelX + pixelY * pixelY);
            if (distance <= brushSize/2) {
              data[i + 3] = 0;
            }
          }
        }
        ctx.putImageData(imageData, x - brushSize/2, y - brushSize/2);
      } else if (isGradientMode) {
        const gradientColor = updateGradientColor();
        ctx.lineTo(x, y);
        ctx.strokeStyle = gradientColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = "round";
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
      } else {
        ctx.lineTo(x, y);
        ctx.strokeStyle = currentColor;
        ctx.lineWidth = brushSize;
        ctx.lineCap = "round";
        ctx.stroke();
        ctx.beginPath();
        ctx.moveTo(x, y);
        const colorName = getColorNameFromRGB(currentColor);
        if (colorName) playNote(colorName);
      }
    }

    function getEventCoords(e) {
      const rect = colorCanvas.getBoundingClientRect();
      let x, y;
      
      if (e.touches && e.touches.length > 0) {
        x = e.touches[0].clientX - rect.left;
        y = e.touches[0].clientY - rect.top;
      } else {
        x = e.clientX - rect.left;
        y = e.clientY - rect.top;
      }
      
      x = x * (colorCanvas.width / rect.width);
      y = y * (colorCanvas.height / rect.height);
      
      return { x, y };
    }

    function startDraw(e) {
      e.preventDefault();
      initAudio();
      painting = true;
      
      lastPlayedNote = null;
      eraserAudioTimer = 0;
      eraserMoving = false;
      eraserPath = [];
      
      const coords = getEventCoords(e);
      ctx.beginPath();
      ctx.moveTo(coords.x, coords.y);
      
      if (isGradientMode) {
        gradientColors = shuffleArray(colors);
        gradientIndex = 0;
        lastColorChangeTime = Date.now();
        currentGradientColor = gradientColors[0];
        nextGradientColor = gradientColors[1];
        colorTransitionProgress = 0;
        if (audioInitialized && synth) {
          try {
            synth.triggerAttackRelease(colorNotes[currentGradientColor.name], "2n");
          } catch (error) {
            console.log('Audio playback error:', error);
          }
        }
      }
      
      draw(coords.x, coords.y);
    }

    function endDraw(e) {
      e.preventDefault();
      painting = false;
      eraserMoving = false;
      eraserPath = [];
      ctx.beginPath();
    }

    function moveDraw(e) {
      e.preventDefault();
      if (!painting) return;
      const coords = getEventCoords(e);
      draw(coords.x, coords.y);
    }

    // Dropdown functionality
    const dropdownToggle = document.getElementById('dropdownToggle');
    const dropdownMenu = document.getElementById('dropdownMenu');
    let isDropdownOpen = false;

    function toggleDropdown() {
      isDropdownOpen = !isDropdownOpen;
      if (isDropdownOpen) {
        dropdownMenu.classList.add('open');
        dropdownToggle.textContent = '✕';
        dropdownToggle.classList.add('selected');
      } else {
        dropdownMenu.classList.remove('open');
        dropdownToggle.textContent = '☰';
        dropdownToggle.classList.remove('selected');
      }
    }

    dropdownToggle.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleDropdown();
    });

    dropdownToggle.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      toggleDropdown();
    });

    // Color button event listeners
    document.querySelectorAll('.dropdown-item[data-color]').forEach(button => {
      button.addEventListener('click', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const color = this.getAttribute('data-color');
        setColor(color, this);
      });
      
      button.addEventListener('touchend', function(e) {
        e.preventDefault();
        e.stopPropagation();
        const color = this.getAttribute('data-color');
        setColor(color, this);
      });
    });

    // Gradient button
    document.getElementById('gradientBtn').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      setGradientMode(this);
    });

    document.getElementById('gradientBtn').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      setGradientMode(this);
    });

    // Eraser button
    document.getElementById('eraserBtn').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      setEraserMode(this);
    });

    document.getElementById('eraserBtn').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      setEraserMode(this);
    });

    // Close letter grid
    document.getElementById('closeLetterGrid').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('letterGridModal').style.display = 'none';
    });

    // A Cancel button
    document.getElementById('aCancelBtn').addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      exitAMode();
    });

    document.getElementById('aCancelBtn').addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      exitAMode();
    });

    // Brush size slider
    const brushSizeSlider = document.getElementById('brushSizeSlider');
    const brushSizeLabel = document.getElementById('brushSizeLabel');
    
    brushSizeSlider.addEventListener('input', function(e) {
      e.stopPropagation();
      brushSize = parseInt(e.target.value);
      brushSizeLabel.textContent = brushSize + 'px';
    });

    brushSizeSlider.addEventListener('change', function(e) {
      e.stopPropagation();
      brushSize = parseInt(e.target.value);
      brushSizeLabel.textContent = brushSize + 'px';
    });

    // Reset button
    document.getElementById('mainResetBtn').addEventListener('click', function(e) {
      e.preventDefault();
      resetCanvas();
    });

    document.getElementById('mainResetBtn').addEventListener('touchend', function(e) {
      e.preventDefault();
      resetCanvas();
    });

    // Canvas drawing events
    if (isTouchDevice) {
      colorCanvas.addEventListener('touchstart', startDraw, { passive: false });
      colorCanvas.addEventListener('touchend', endDraw, { passive: false });
      colorCanvas.addEventListener('touchmove', moveDraw, { passive: false });
    } else {
      colorCanvas.addEventListener('mousedown', startDraw);
      colorCanvas.addEventListener('mouseup', endDraw);
      colorCanvas.addEventListener('mousemove', moveDraw);
    }

    // Ensure audio context is started on any user interaction
    document.addEventListener('touchstart', initAudio, { once: true });
    document.addEventListener('click', initAudio, { once: true });

    // Continuous audio maintenance for eraser
    setInterval(maintainEraserAudio, 50);

    // Set initial color selection
    setColor('rgb(255, 0, 221)', document.querySelector('.dropdown-item.pink'));
// Initialize audio on page load for better mobile support
window.addEventListener('DOMContentLoaded', () => {
  // Show enable sound button initially on mobile
  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    setTimeout(showEnableSoundButton, 1000);
  }
});

// Add visibility change listener to reinitialize audio when page becomes visible
document.addEventListener('visibilitychange', () => {
  if (!document.hidden && audioInitialized && synth && Tone.context.state === 'suspended') {
    Tone.start().catch(console.error);
  }
});
    const shapesList = [
      {name:'Horizontal Line',svg:'<svg width="40" height="40"><line x1="5" y1="20" x2="35" y2="20" stroke="#222" stroke-width="4"/></svg>'},
      {name:'Vertical Line',svg:'<svg width="40" height="40"><line x1="20" y1="5" x2="20" y2="35" stroke="#222" stroke-width="4"/></svg>'},
      {name:'Slanting Line',svg:'<svg width="40" height="40"><line x1="8" y1="32" x2="32" y2="8" stroke="#222" stroke-width="4"/></svg>'},
      {name:'Square',svg:'<svg width="40" height="40"><rect x="8" y="8" width="24" height="24" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Rectangle',svg:'<svg width="40" height="40"><rect x="5" y="12" width="30" height="16" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Circle',svg:'<svg width="40" height="40"><circle cx="20" cy="20" r="16" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Triangle',svg:'<svg width="40" height="40"><polygon points="20,6 34,34 6,34" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Semicircle',svg:'<svg width="40" height="40"><path d="M8,32 A12,12 0 0,1 32,32" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Trapezoid',svg:'<svg width="40" height="40"><polygon points="10,34 30,34 34,14 6,14" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Pentagon',svg:'<svg width="40" height="40"><polygon points="20,6 34,16 28,34 12,34 6,16" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Hexagon',svg:'<svg width="40" height="40"><polygon points="20,6 34,14 34,26 20,34 6,26 6,14" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Octagon',svg:'<svg width="40" height="40"><polygon points="12,6 28,6 34,12 34,28 28,34 12,34 6,28 6,12" stroke="#222" stroke-width="4" fill="none"/></svg>'},
      {name:'Star',svg:'<svg width="40" height="40"><polygon points="20,6 24,16 34,16 26,22 30,32 20,26 10,32 14,22 6,16 16,16" stroke="#222" stroke-width="3" fill="none"/></svg>'},
      {name:'Heart',svg:'<svg width="40" height="40"><path d="M20,36 C-8,12 8,-8 20,8 C32,-8 48,12 20,36 Z" stroke="#222" stroke-width="3" fill="none"/></svg>'},
      {name:'Smiley',svg:'<svg width="40" height="40"><circle cx="20" cy="20" r="14" stroke="#222" stroke-width="3" fill="none"/><circle cx="15" cy="17" r="2" fill="#222"/><circle cx="25" cy="17" r="2" fill="#222"/><path d="M14,25 Q20,30 26,25" stroke="#222" stroke-width="2" fill="none"/></svg>'},
      {name:'Sun',svg:'<svg width="40" height="40" viewBox="0 0 40 40"><circle cx="20" cy="20" r="10" stroke="#222" stroke-width="3" fill="none"/><g stroke="#222" stroke-width="3"><line x1="20" y1="2" x2="20" y2="10"/><line x1="20" y1="30" x2="20" y2="38"/><line x1="2" y1="20" x2="10" y2="20"/><line x1="30" y1="20" x2="38" y2="20"/><line x1="7" y1="7" x2="13" y2="13"/><line x1="27" y1="27" x2="33" y2="33"/><line x1="7" y1="33" x2="13" y2="27"/><line x1="27" y1="13" x2="33" y2="7"/></g></svg>'},
      {name:'Fish',svg:'<svg width="40" height="40" viewBox="-60 -40 160 80"><g><path d="M-60,0 Q0,-56 60,0 Q0,56 -60,0 Z" stroke="#222" stroke-width="8" fill="none"/><polygon points="60,0 100,-30 100,30" stroke="#222" stroke-width="8" fill="none"/><circle cx="-36" cy="0" r="4" fill="#222"/></g></svg>'}
    ];

    function createShapesGrid() {
      const shapesGrid = document.getElementById('shapesGrid');
      const closeBtn = document.getElementById('closeShapesGrid');
      shapesGrid.innerHTML = '';
      shapesGrid.appendChild(closeBtn);
      shapesList.forEach(shape => {
        const item = document.createElement('button');
        item.className = 'shapes-item';
        item.title = shape.name;
        item.innerHTML = shape.svg;
        item.onclick = () => showShapeStencilOverlay(shape.name);
        shapesGrid.appendChild(item);
      });
    }

    // Show shapes grid modal
    const shapesBtn = document.getElementById('shapesBtn');
    shapesBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('letterGridModal').style.display = 'none';
      document.getElementById('gujaratiGridModal').style.display = 'none';
      createShapesGrid();
      document.getElementById('shapesGridModal').style.display = 'flex';
    });
    shapesBtn.addEventListener('touchend', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('letterGridModal').style.display = 'none';
      document.getElementById('gujaratiGridModal').style.display = 'none';
      createShapesGrid();
      document.getElementById('shapesGridModal').style.display = 'flex';
    });
    // Close shapes grid
    const closeShapesGrid = document.getElementById('closeShapesGrid');
    closeShapesGrid.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      document.getElementById('shapesGridModal').style.display = 'none';
    });

    function showShapeStencilOverlay(shapeName) {
      // Hide the shapes grid modal
      document.getElementById('shapesGridModal').style.display = 'none';
      // Get the overlay canvas
      const overlay = document.getElementById('aOverlay');
      overlay.style.display = 'block';
      const ctx = overlay.getContext('2d');
      ctx.clearRect(0, 0, overlay.width, overlay.height);
      // Fill overlay with black
      ctx.globalAlpha = 1;
      ctx.fillStyle = 'black';
      ctx.fillRect(0, 0, overlay.width, overlay.height);
      // Draw the shape stencil in the center
      ctx.globalCompositeOperation = 'destination-out';
      ctx.save();
      ctx.translate(overlay.width/2, overlay.height/2);
      ctx.scale(Math.min(overlay.width, overlay.height)/200, Math.min(overlay.width, overlay.height)/200);
      drawShapeStencil(ctx, shapeName);
      ctx.restore();
      ctx.globalCompositeOperation = 'source-over';
      // Show close button
      document.getElementById('stencilCloseBtn').style.display = 'flex';
      // Set stencil mode
      isStencilMode = true;
    }

    function drawShapeStencil(ctx, shapeName) {
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 10;
      ctx.fillStyle = 'white';
      switch(shapeName) {
        case 'Triangle':
          ctx.beginPath();
          ctx.moveTo(0, -60); // top
          ctx.lineTo(52, 52); // bottom right
          ctx.lineTo(-52, 52); // bottom left
          ctx.closePath();
          ctx.stroke();
          break;
        case 'Semicircle':
          ctx.beginPath();
          ctx.arc(0, 0, 60, Math.PI, 0, false); // semicircle (bottom flat)
          ctx.stroke();
          break;
        case 'Trapezoid':
          ctx.beginPath();
          ctx.moveTo(-40, 52); // bottom left
          ctx.lineTo(40, 52); // bottom right
          ctx.lineTo(60, -40); // top right
          ctx.lineTo(-60, -40); // top left
          ctx.closePath();
          ctx.stroke();
          break;
        case 'Pentagon':
          ctx.beginPath();
          for(let i=0;i<5;i++){
            let angle = (Math.PI*2/5)*i - Math.PI/2;
            let x = Math.cos(angle)*60, y = Math.sin(angle)*60;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          }
          ctx.closePath();
          ctx.stroke();
          break;
        case 'Fish':
          ctx.save();
          ctx.lineWidth = 10;
          ctx.strokeStyle = 'white';
          // Center the fish by adjusting translation
          ctx.translate(-20, 0);
          // Fish body outline (sharper head, more open tail)
          ctx.beginPath();
          ctx.moveTo(-60, 0);
          ctx.quadraticCurveTo(0, -56, 60, 0);
          ctx.quadraticCurveTo(0, 56, -60, 0);
          ctx.closePath();
          ctx.stroke();
          // Fish tail (triangle matches red outline)
          ctx.beginPath();
          ctx.moveTo(60, 0);
          ctx.lineTo(100, -30);
          ctx.lineTo(100, 30);
          ctx.lineTo(60, 0);
          ctx.closePath();
          ctx.stroke();
          // Fish eye (shift downward into body to match red dot in image)
          ctx.beginPath();
          ctx.arc(-36, 0, 3, 0, Math.PI * 2);
          ctx.fillStyle = 'white';
          ctx.fill();
          ctx.restore();
          break;
        case 'Horizontal Line':
          ctx.beginPath();
          ctx.moveTo(-60, 0); ctx.lineTo(60, 0); ctx.stroke(); break;
        case 'Vertical Line':
          ctx.beginPath();
          ctx.moveTo(0, -60); ctx.lineTo(0, 60); ctx.stroke(); break;
        case 'Slanting Line':
          ctx.beginPath();
          ctx.moveTo(-60, 60); ctx.lineTo(60, -60); ctx.stroke(); break;
        case 'Square':
          ctx.beginPath();
          ctx.rect(-50, -50, 100, 100); ctx.stroke(); break;
        case 'Rectangle':
          ctx.beginPath();
          ctx.rect(-70, -40, 140, 80); ctx.stroke(); break;
        case 'Circle':
          ctx.beginPath();
          ctx.arc(0, 0, 60, 0, Math.PI * 2); ctx.stroke(); break;
        case 'Sun':
          ctx.save();
          // Match line width to other stencils
          ctx.lineWidth = 10;
          ctx.strokeStyle = 'white';
          // Center circle radius matches other stencils
          const baseRadius = 40;
          // Ray lengths and angles to match icon
          const rayAngles = [0, Math.PI/4, Math.PI/2, 3*Math.PI/4, Math.PI, 5*Math.PI/4, 3*Math.PI/2, 7*Math.PI/4];
          const rayInner = baseRadius + 10;
          const rayOuter = baseRadius + 30;
          // Draw center circle
          ctx.beginPath();
          ctx.arc(0, 0, baseRadius, 0, Math.PI * 2);
          ctx.stroke();
          // Draw rays
          for (let i = 0; i < rayAngles.length; i++) {
            const angle = rayAngles[i];
            const x1 = Math.cos(angle) * rayInner;
            const y1 = Math.sin(angle) * rayInner;
            const x2 = Math.cos(angle) * rayOuter;
            const y2 = Math.sin(angle) * rayOuter;
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
          }
          ctx.restore();
          break;
        case 'Hexagon':
          ctx.beginPath();
          for(let i=0;i<6;i++){
            let angle = (Math.PI*2/6)*i - Math.PI/2;
            let x = Math.cos(angle)*60, y = Math.sin(angle)*60;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          } ctx.closePath(); ctx.stroke(); break;
        case 'Octagon':
          ctx.beginPath();
          for(let i=0;i<8;i++){
            let angle = (Math.PI*2/8)*i - Math.PI/2;
            let x = Math.cos(angle)*60, y = Math.sin(angle)*60;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          } ctx.closePath(); ctx.stroke(); break;
        case 'Star':
          ctx.beginPath();
          for(let i=0;i<10;i++){
            let angle = (Math.PI/5)*i - Math.PI/2;
            let r = i%2===0?60:25;
            let x = Math.cos(angle)*r, y = Math.sin(angle)*r;
            if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
          } ctx.closePath(); ctx.stroke(); break;
        case 'Heart':
          ctx.beginPath();
          ctx.moveTo(0, 40); // Bottom point
          ctx.bezierCurveTo(-60, 10, -30, -60, 0, -10); // Left top curve
          ctx.bezierCurveTo(30, -60, 60, 10, 0, 40); // Right top curve
          ctx.closePath();
          ctx.stroke();
          break;
        case 'Smiley':
          ctx.beginPath();
          ctx.arc(0, 0, 60, 0, Math.PI*2); ctx.stroke();
          ctx.beginPath();
          ctx.arc(-20, -15, 7, 0, Math.PI*2); ctx.stroke();
          ctx.beginPath();
          ctx.arc(20, -15, 7, 0, Math.PI*2); ctx.stroke();
          ctx.beginPath();
          ctx.arc(0, 20, 22, Math.PI*0.15, Math.PI*0.85, false); ctx.stroke();
          break;
      }
    }
  </script>
</body>
</html>